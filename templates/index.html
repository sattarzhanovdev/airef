<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>AI Food Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        --bg: #f7f8fc;
        --card: #ffffff;
        --primary: #5b5ce2;
        --border: #e6e8f0;
        --text: #111827;
        --muted: #6b7280;
        --success: #16a34a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Arial;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
      }
      .sidebar {
        width: 240px;
        background: #0f172a;
        color: #fff;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .logo {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 24px;
      }
      .nav button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 12px;
        margin-bottom: 8px;
        background: transparent;
        color: #c7d2fe;
        cursor: pointer;
        text-align: left;
        font-size: 14px;
      }
      .nav button.active,
      .nav button:hover {
        background: #1e293b;
        color: #fff;
      }
      .main {
        flex: 1;
        display: none;
        flex-direction: column;
        height: 100vh;
      }
      .main.active {
        display: flex;
      }
      .header {
        padding: 18px 24px;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h2 {
        margin: 0;
        font-size: 18px;
      }
      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
      }
      .msg {
        max-width: 820px;
        padding: 14px 16px;
        border-radius: 14px;
        margin-bottom: 14px;
        line-height: 1.6;
      }
      .user {
        background: var(--primary);
        color: #fff;
        margin-left: auto;
      }
      .ai {
        background: var(--card);
        border: 1px solid var(--border);
      }
      .chat-input {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: var(--card);
        border-top: 1px solid var(--border);
      }
      .chat-input input {
        flex: 1;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 14px;
      }
      .chat-input button {
        padding: 0 22px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 500;
        cursor: pointer;
      }
      .grid {
        padding: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
      }
      .card {
        background: var(--card);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .card h4 {
        margin: 0;
        font-size: 16px;
      }
      .badge {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        width: max-content;
      }
      .qty {
        color: var(--muted);
        font-size: 14px;
      }
      .card-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
      }
      .card-actions button {
        flex: 1;
        padding: 8px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 13px;
      }
      .edit {
        background: #eef2ff;
      }
      .delete {
        background: #fee2e2;
      }
      .section {
        padding: 24px;
        border-top: 1px solid var(--border);
        background: var(--card);
      }
      .row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      .row input,
      .row textarea {
        flex: 1;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 14px;
      }
      .row button {
        padding: 0 20px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        cursor: pointer;
      }
      .loader {
        height: 120px;
        border-radius: 18px;
        background: linear-gradient(90deg, #eee, #f5f5f5, #eee);
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: -200px;
        }
        100% {
          background-position: 200px;
        }
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-box {
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        width: 340px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .modal-box input {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
      }
      .modal-box button {
        padding: 12px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
      }
      .loading-btn {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo">üçΩ AI Food</div>
      <div class="nav">
        <button class="active" onclick="openPage('chat', this)">ü§ñ –ß–∞—Ç</button>
        <button onclick="openPage('fridge', this)">üì¶ –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</button>
      </div>
    </div>

    <div id="chat" class="main active">
      <div class="header"><h2>AI Food Chat</h2></div>
      <div id="chatBody" class="chat-body"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="–ß—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?" />
        <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div id="fridge" class="main">
      <div class="header"><h2>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</h2></div>

      <div id="fridgeGrid" class="grid"></div>

      <div class="section">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
        <div class="row">
          <input id="newName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
          <input id="newQty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" />
          <input id="newCat" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" />
          <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="section">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∏–∑ —á–µ–∫–∞ (—Ç–µ–∫—Å—Ç)</h3>
        <div class="row">
          <textarea id="receiptText" placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —á–µ–∫–∞"></textarea>
        </div>
        <div class="row">
          <button id="receiptTextBtn" onclick="sendReceiptText()">
            –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–µ–∫
          </button>
        </div>
      </div>

      <div class="section">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∏–∑ —á–µ–∫–∞ (—Ñ–æ—Ç–æ)</h3>
        <div class="row">
          <input type="file" id="receiptImage" />
          <button id="receiptImgBtn" onclick="sendReceiptImage()">
            –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
          </button>
        </div>
      </div>
    </div>

    <div id="modal" class="modal">
      <div class="modal-box">
        <input id="editName" />
        <input id="editQty" />
        <input id="editCat" />
        <button onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <script>
      const API = "/api";
      let editId = null;

      function openPage(id, btn) {
        document
          .querySelectorAll(".main")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".nav button")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        btn.classList.add("active");
      }

      async function sendChat() {
        if (!chatInput.value.trim()) return;
        chatBody.innerHTML += `<div class="msg user">${chatInput.value}</div>`;
        const ai = document.createElement("div");
        ai.className = "msg ai";
        chatBody.appendChild(ai);
        let buf = "";
        const res = await fetch(API + "/chat/stream/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: chatInput.value }),
        });
        chatInput.value = "";
        const r = res.body.getReader(),
          d = new TextDecoder();
        while (true) {
          const { value, done } = await r.read();
          if (done) break;
          buf += d.decode(value);
          ai.innerHTML = marked.parse(buf);
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      }

      async function loadFridge() {
        fridgeGrid.innerHTML = "";
        for (let i = 0; i < 6; i++)
          fridgeGrid.innerHTML += `<div class="loader"></div>`;
        const res = await fetch(API + "/fridge/");
        const data = await res.json();
        fridgeGrid.innerHTML = "";
        data.forEach((p) => {
          fridgeGrid.innerHTML += `
<div class="card">
<h4>${p.name}</h4>
<div class="badge">${p.category}</div>
<div class="qty">${p.quantity}</div>
<div class="card-actions">
<button class="edit" onclick="openEdit(${p.id},'${p.name}','${p.quantity}','${p.category}')">–ò–∑–º.</button>
<button class="delete" onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>`;
        });
      }

      async function addProduct() {
        if (!newName.value) return;
        await fetch(API + "/fridge/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: newName.value,
            quantity: newQty.value,
            category: newCat.value,
          }),
        });
        newName.value = newQty.value = newCat.value = "";
        loadFridge();
      }

      async function deleteProduct(id) {
        await fetch(API + "/fridge/" + id + "/", { method: "DELETE" });
        loadFridge();
      }

      function openEdit(id, n, q, c) {
        editId = id;
        editName.value = n;
        editQty.value = q;
        editCat.value = c;
        modal.classList.add("active");
      }

      async function saveEdit() {
        await fetch(API + "/fridge/" + editId + "/", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: editName.value,
            quantity: editQty.value,
            category: editCat.value,
          }),
        });
        modal.classList.remove("active");
        loadFridge();
      }

      async function sendReceiptText() {
        if (!receiptText.value) return;
        receiptTextBtn.classList.add("loading-btn");
        await fetch(API + "/receipt/text/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: receiptText.value }),
        });
        receiptText.value = "";
        receiptTextBtn.classList.remove("loading-btn");
        loadFridge();
      }

      async function sendReceiptImage() {
        const file = receiptImage.files[0];
        if (!file) return;
        receiptImgBtn.classList.add("loading-btn");
        const fd = new FormData();
        fd.append("image", file);
        await fetch(API + "/receipt/image/", { method: "POST", body: fd });
        receiptImage.value = "";
        receiptImgBtn.classList.remove("loading-btn");
        loadFridge();
      }

      modal.onclick = (e) => {
        if (e.target.id === "modal") modal.classList.remove("active");
      };

      loadFridge();
    </script>
  </body>
</html>
